# 画像同期ガイド

`uploads/` と `uploads/uses/` にある画像を `static/images/materials/` に同期する手順です。

## 概要

このスクリプトは、アップロードされた画像をMaterial Mapの統一構成に変換します。

### 命名規則

- `uploads/{素材名}.*` → `static/images/materials/{safe_slug}/primary/primary.png`
- `uploads/uses/{素材名}1.*` → `static/images/materials/{safe_slug}/uses/space.png`
- `uploads/uses/{素材名}2.*` → `static/images/materials/{safe_slug}/uses/product.png`

### 画像の正規化

- すべての画像はPNG形式に変換されます
- 透過画像は白背景に合成されます
- 元の拡張子（webp/jpg/jpeg等）は問いません

## 実行手順

### 1. ドライラン（確認のみ）

まず、実際にコピーせずに何が同期されるか確認します：

```bash
python scripts/sync_uploaded_images.py --dry-run
```

### 2. 実際の同期実行

問題がなければ、実際に同期を実行します：

```bash
python scripts/sync_uploaded_images.py
```

### 3. DB登録をスキップする場合

画像の同期のみを行い、UseExampleのDB登録をスキップする場合：

```bash
python scripts/sync_uploaded_images.py --no-db
```

## 実行例

### ドライランの出力例

```
============================================================
画像同期スクリプト
============================================================
📂 ソース: /path/to/uploads
📂 保存先: /path/to/static/images/materials
🔍 ドライランモード

📦 9 件の素材を発見しました

📁 アルミニウム (slug: アルミニウム)
  🔍 ドライラン: uploads/アルミニウム.png -> static/images/materials/アルミニウム/primary/primary.png
  🔍 ドライラン: uploads/uses/アルミニウム1.png -> static/images/materials/アルミニウム/uses/space.png
  🔍 ドライラン: uploads/uses/アルミニウム2.png -> static/images/materials/アルミニウム/uses/product.png

📁 栗材 (slug: 栗材)
  🔍 ドライラン: uploads/栗材.jpg -> static/images/materials/栗材/primary/primary.png
  🔍 ドライラン: uploads/uses/栗材1.png -> static/images/materials/栗材/uses/space.png
  🔍 ドライラン: uploads/uses/栗材2.png -> static/images/materials/栗材/uses/product.png

...

============================================================
📊 同期結果
============================================================
✅ 同期: 27 件
⏭️  スキップ: 0 件
❌ エラー: 0 件

============================================================
📝 DB登録（使用例）
============================================================
✅ 登録: 18 件
⏭️  スキップ: 0 件

============================================================
✨ 完了
============================================================
```

### 実際の同期実行の出力例

```
============================================================
画像同期スクリプト
============================================================
📂 ソース: /path/to/uploads
📂 保存先: /path/to/static/images/materials

📦 9 件の素材を発見しました

📁 アルミニウム (slug: アルミニウム)
  ✅ primary: アルミニウム.png -> primary.png
  ✅ space: アルミニウム1.png -> space.png
  ✅ product: アルミニウム2.png -> product.png

📁 栗材 (slug: 栗材)
  ✅ primary: 栗材.jpg -> primary.png
  ✅ space: 栗材1.png -> space.png
  ✅ product: 栗材2.png -> product.png

...

============================================================
📊 同期結果
============================================================
✅ 同期: 27 件
⏭️  スキップ: 0 件
❌ エラー: 0 件

============================================================
📝 DB登録（使用例）
============================================================
  ✅ DB登録: アルミニウム - 空間の使用例
  ✅ DB登録: アルミニウム - プロダクトの使用例
  ✅ DB登録: 栗材 - 空間の使用例
  ✅ DB登録: 栗材 - プロダクトの使用例
  ...
✅ 登録: 18 件
⏭️  スキップ: 0 件

============================================================
✨ 完了
============================================================
```

## 生成されるファイル構造

同期後、以下のような構造になります：

```
static/images/materials/
├── アルミニウム/
│   ├── primary/
│   │   └── primary.png
│   └── uses/
│       ├── space.png
│       └── product.png
├── 栗材/
│   ├── primary/
│   │   └── primary.png
│   └── uses/
│       ├── space.png
│       └── product.png
└── ...
```

## UIでの表示

同期された画像は、以下の場所で自動的に表示されます：

1. **ホームページ** - 「最近登録された材料」セクション
2. **材料一覧ページ** - 材料カードのサムネイル
3. **材料詳細ページ** - 「入手先・用途」タブの使用例セクション

画像が見つからない場合は、プレースホルダーが表示されます（アプリは落ちません）。

## Streamlit Cloudでの反映

1. ローカルで同期を実行
2. 変更をコミット・プッシュ
3. Streamlit Cloudが自動デプロイ
4. デプロイ後、画像が表示されることを確認

## 注意事項

- 既存の画像は上書きされます（バックアップを推奨）
- DB登録はidempotentです（同じ材料に同じ用途例を重複登録しません）
- 画像の変換には時間がかかる場合があります（大量の画像がある場合）
- エラーが発生した場合、ログを確認してください

## トラブルシューティング

### エラー: "画像の読み込みに失敗しました"

- 元画像が破損している可能性があります
- ファイル形式がサポートされていない可能性があります（PNG/JPEG/WebP以外）

### エラー: "DB登録に失敗しました"

- データベースがロックされている可能性があります
- 材料がDBに存在しない可能性があります（先に材料を登録してください）

### 画像が表示されない

- `static/images/materials/` ディレクトリが正しく作成されているか確認
- ファイル名が正しいか確認（`primary.png`, `space.png`, `product.png`）
- ブラウザのキャッシュをクリア

